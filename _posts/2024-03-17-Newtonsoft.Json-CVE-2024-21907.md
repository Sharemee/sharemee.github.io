---
layout: post
title: "Newtonsoft.Json CVE-2024-21907"
---

在 Newtonsoft.Json 13.0.1 之前的版本中容易受到不安全的默认值攻击, 对高嵌套级别表达式的处理不当会导致 StackOverFlow 异常或高 CPU 和 RAM 使用率。 利用此漏洞会导致拒绝服务(DoS)。

1. 执行序列化方法（如 JsonConvert.Serialize 或 JObject.ToString ）将抛出StackOverFlow异常，嵌套级别约为20k。

2. 执行反序列化方法（如 JsonConvert.DeserializeObject ）将处理输入，这将导致消耗CPU、分配内存和消耗执行线程。需要相当高的嵌套级别（>10kk，或9.5MB的 {a:{a:{... 输入）来实现超过10秒的延迟，具体取决于硬件。

关于问题只影响IIS应用程序的原始声明是误导性的。任何应用程序都会受到影响，但IIS会在一段时间后停止重新启动实例，从而导致难以修复的DoS。

## 解决方案

共有两种解决方案

### 1. 升级 Newtonsoft.Json 至 13.0.1 或更新版本

### 2.或在 JsonSerializerSettings 中设置 MaxDepth 参数

这可以通过下面的语句在全局范围内完成。在此之后，嵌套输入的解析将快速失败，并显示 Newtonsoft.Json.JsonReaderException ：

```csharp
JsonConvert.DefaultSettings = () => new JsonSerializerSettings { MaxDepth = 128 };
```

> 在 Github 中查看关于该漏洞的信息 : <https://github.com/advisories/GHSA-5crp-9r3c-p9vr>
> 在 cve.mitre.org 中搜索关于 [CVE-2024-21907](https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=CVE-2024-21907) 漏洞的信息
